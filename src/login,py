from tkinter import *
from tkinter import messagebox, simpledialog
import bcrypt
import json
import os

# Membuat folder 'data' jika belum ada
if not os.path.exists('data'):
    os.makedirs('data')

DATA_FILE = 'data/datasheet.txt'
QUESTION_FILE = 'data/questions.json'

# Fungsi Hash Password
def hash_password(password):
    return bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt())

def check_password(hashed, password):
    return bcrypt.checkpw(password.encode('utf-8'), hashed)

# Fungsi untuk Load Data Users
def load_users():
    try:
        with open(DATA_FILE, 'rb') as file:
            return json.load(file)
    except FileNotFoundError:
        return {}
    except json.JSONDecodeError:
        return {}

def save_users(users):
    with open(DATA_FILE, 'w') as file:
        json.dump(users, file)

# Fungsi untuk Load Soal
def load_questions():
    try:
        with open(QUESTION_FILE, 'r') as file:
            return json.load(file)
    except (FileNotFoundError, json.JSONDecodeError):
        return []

def save_questions(questions):
    with open(QUESTION_FILE, 'w') as file:
        json.dump(questions, file)

# Fungsi Sign Up
def signup_window():
    def register():
        username = user_entry.get()
        password = pass_entry.get()
        role = role_var.get()

        if not username or not password or not role:
            messagebox.showerror('Error', 'Semua kolom harus diisi!')
            return

        users = load_users()

        if username in users:
            messagebox.showerror('Error', 'Username sudah terdaftar!')
            return

        hashed_password = hash_password(password).decode('utf-8')
        users[username] = {'password': hashed_password, 'role': role}
        save_users(users)
        messagebox.showinfo('Sukses', f'Akun {username} berhasil dibuat!')
        signup.destroy()

    signup = Toplevel()
    signup.title('Sign Up')
    signup.state('zoomed')
    signup.configure(bg='#fff')

    img = PhotoImage(file='assets/login.png')  
    resized_img = img.subsample(1, 1)
    img_label = Label(signup, image=resized_img, border=0, bg='white')
    img_label.image = resized_img
    img_label.place(relx=0.3, rely=0.5, anchor='center')

    frame = Frame(signup, width=400, height=400, bg='#fff')
    frame.place(relx=0.7, rely=0.5, anchor='center')

    heading = Label(frame, text='Sign Up', fg="#57a1f8", bg='white', font=('Microsoft Yahei UI Light', 26, 'bold'))
    heading.pack(pady=20)

    Label(frame, text='Username', bg='white', fg='black', font=('Microsoft Yahei UI Light', 12)).pack(pady=5)
    user_entry = Entry(frame, width=30, font=('Microsoft Yahei UI Light', 12))
    user_entry.pack(pady=10)

    Label(frame, text='Password', bg='white', fg='black', font=('Microsoft Yahei UI Light', 12)).pack(pady=5)
    pass_entry = Entry(frame, width=30, show="*", font=('Microsoft Yahei UI Light', 12))
    pass_entry.pack(pady=10)

    Label(frame, text='Role (admin/peserta)', bg='white', fg='black', font=('Microsoft Yahei UI Light', 12)).pack(pady=5)
    role_var = StringVar()
    role_menu = OptionMenu(frame, role_var, 'admin', 'peserta')
    role_menu.pack(pady=10)

    Button(frame, text='Register', bg="#57a1f8", fg="white", font=('Microsoft Yahei UI Light', 12), command=register).pack(pady=20)


# Fungsi Sign In
def signin_window():
    def login():
        username = user_entry.get()
        password = pass_entry.get()

        users = load_users()

        if username not in users or not check_password(users[username]['password'].encode('utf-8'), password):
            messagebox.showerror('Error', 'Username atau password salah!')
            return

        role = users[username]['role']
        messagebox.showinfo('Sukses', f'Login berhasil sebagai {role}!')
        signin.destroy()
        if role == 'admin':
            admin_window()
        else:
            quiz_window()

    signin = Tk()
    signin.title('Sign In')
    signin.state('zoomed')
    signin.configure(bg='#fff')

    img = PhotoImage(file='assets/login.png')  
    resized_img = img.subsample(1, 1)  
    img_label = Label(signin, image=resized_img, border=0, bg='white')
    img_label.image = resized_img
    img_label.place(relx=0.3, rely=0.5, anchor='center')

    frame = Frame(signin, width=400, height=400, bg='#fff')
    frame.place(relx=0.7, rely=0.5, anchor='center')

    heading = Label(frame, text='Sign In', fg="#57a1f8", bg='white', font=('Microsoft Yahei UI Light', 26, 'bold'))
    heading.pack(pady=20)

    Label(frame, text='Username', bg='white', fg='black', font=('Microsoft Yahei UI Light', 12)).pack(pady=5)
    user_entry = Entry(frame, width=30, font=('Microsoft Yahei UI Light', 12))
    user_entry.pack(pady=10)

    Label(frame, text='Password', bg='white', fg='black', font=('Microsoft Yahei UI Light', 12)).pack(pady=5)
    pass_entry = Entry(frame, width=30, show="*", font=('Microsoft Yahei UI Light', 12))
    pass_entry.pack(pady=10)

    Button(frame, text='Sign In', bg="#57a1f8", fg="white", font=('Microsoft Yahei UI Light', 12), command=login).pack(pady=20)
    Button(frame, text='Don\'t have an account? Sign Up', bg="white", fg="#57a1f8", border=0, command=signup_window).pack()

    signin.mainloop()


# Admin Window
def admin_window():
    def add_question():
        question = simpledialog.askstring('Tambah Soal', 'Masukkan soal:')
        if not question:
            return
        options = [simpledialog.askstring('Tambah Opsi', f'Pilihan {i+1}:') for i in range(4)]
        correct = simpledialog.askinteger('Jawaban Benar', 'Index jawaban benar (0-3):')

        questions = load_questions()
        questions.append({'question': question, 'options': options, 'correct_option': correct})
        save_questions(questions)
        messagebox.showinfo('Sukses', 'Soal berhasil ditambahkan!')

    admin = Tk()
    admin.title('Admin - Edit Kuis')
    admin.state('zoomed')

    frame = Frame(admin)
    frame.pack(expand=True, fill='both')

    Label(frame, text='Admin Panel', font=('Arial', 16, 'bold')).pack(pady=10)
    Button(frame, text='Tambah Soal', command=add_question).pack(pady=10, fill=X)

    admin.mainloop()

# Quiz Window
def quiz_window():
    questions = load_questions()
    score = 0

    def next_question():
        nonlocal score, index
        if index < len(questions):
            question_label.config(text=questions[index]['question'])
            for i, option in enumerate(questions[index]['options']):
                option_buttons[i].config(text=option, value=i)
        else:
            messagebox.showinfo('Hasil', f'Nilai Anda: {score}/{len(questions)}')
            quiz.destroy()

    def check_answer():
        nonlocal score, index
        if answer_var.get() == questions[index]['correct_option']:
            score += 1
        index += 1
        next_question()

    index = 0
    quiz = Tk()
    quiz.title('Quiz')
    quiz.state('zoomed')

    frame = Frame(quiz)
    frame.pack(expand=True, fill='both')

    question_label = Label(frame, text='', wraplength=800)
    question_label.pack(pady=20, fill=X)

    answer_var = IntVar()
    option_buttons = [Radiobutton(frame, text='', variable=answer_var, value=i) for i in range(4)]
    for btn in option_buttons:
        btn.pack(anchor="w")

    Button(frame, text='Submit', command=check_answer).pack(pady=20, fill=X)
    next_question()

    quiz.mainloop()

if __name__ == '__main__':
    signin_window()
